---
title: "Projekt z analizy danych"
author: "Joanna Chromiñska"
date: "22 listopada 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    cols.print: 6
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Podsumowanie

## Wykorzystane biblioteki: {#section1}

```{r wykorzystaneBibioteki, message=FALSE}
library(knitr)
library(shiny)
library(plotly)
library(ggplot2)
library(dplyr)
library(caret)
library(pROC)
```

## Wczytanie danych {#section2}

```{r wczytDanych, echo=TRUE, cache=TRUE, message=FALSE}

elektrownie <- as.data.frame(read.csv("elektrownie.csv"));

```
```{r wczytDanychDoWykr, echo=FALSE, cache=TRUE}

elektrownie_wykr <- filter(elektrownie, pressure != 0);
elektrownie_wykr <- filter(elektrownie, irr_pvgis_mod != 0);  
elektrownie_wykr <- filter(elektrownie, pressurei != 0);

```


## Przetwarzanie brakuj¹cych danych {#section3}

```{r przetwNa, echo = FALSE, cache=FALSE, message=FALSE}
sr_pressure <- mean(elektrownie$pressure);
sr_pressurei <- mean(elektrownie$pressurei);
sr_dist <- mean(elektrownie$dist);
sr_altitude <- mean(elektrownie$altitude);
sr_azimuth <- mean(elektrownie$azimuth);
sr_altitudei <- mean(elektrownie$altitudei);
sr_azimuthi <- mean(elektrownie$azimuthi);
elektrownie <- mutate(elektrownie, pressure = ifelse(pressure == 0, sr_pressure, pressure));
elektrownie <- mutate(elektrownie, pressurei = ifelse(pressurei == 0, sr_pressurei, pressurei));
elektrownie <- mutate(elektrownie, dist = ifelse(dist == 0, sr_dist, dist));
elektrownie <- mutate(elektrownie, altitude = ifelse(altitude == 0, sr_altitude, altitude));
elektrownie <- mutate(elektrownie, azimuth = ifelse(azimuth == 0, sr_azimuth, azimuth));
elektrownie <- mutate(elektrownie, altitudei = ifelse(altitudei == 0, sr_altitudei, altitudei));
elektrownie <- mutate(elektrownie, azimuthi = ifelse(azimuthi == 0, sr_azimuthi, azimuthi));
renderTable(head(elektrownie));

```


## Rozmiar zbioru i podstawowe statystyki {#section4}

```{r statystykiPodst, echo=FALSE, message=FALSE}

renderTable(summary(elektrownie));
wierszy <- nrow(elektrownie);
atrybuty <- names(elektrownie);

```


## Szczegó³owa analiza wartoœci atrybutów {#section5}

```{r wartAttr, echo = FALSE, cache=FALSE, message=FALSE}
azimuth_plot <- plot_ly(elektrownie_wykr, x = ~data, y = ~azimuth, type = "scatter", name = 'Umiejscowienie geograficzne w czasie');
pressure_plot <- plot_ly(elektrownie_wykr, x = ~data, y = ~pressure, type = "scatter", name = 'Cisnienie w czasie');
wilgotnosc_plot <- plot_ly(elektrownie_wykr, x = ~data, y = ~humidity, type = "scatter", name = 'Wilgotnosc w czasie');
temp_plot <-plot_ly(elektrownie_wykr, x = ~data, y = ~tempi, type = "scatter", name = 'Temperatura w czasie')
dewpoint_plot <-plot_ly(elektrownie_wykr, x = ~data, y = ~dewpoint, type = "scatter", name = 'Temperatura punktu rosy w czasie') 
dist_plot <-plot_ly(elektrownie_wykr, x = ~data, y = ~dist, type = "scatter", name = 'Odleglosc w czasie')

azimuth_plot;
pressure_plot;
wilgotnosc_plot;
temp_plot;
dewpoint_plot;
dist_plot;

```

## Korelacje miêdzy zmiennymi {#section6}

```{r korelacje, echo=TRUE, message=FALSE}
kor1 <- plot_ly(elektrownie_wykr, x = ~data, y= elektrownie_wykr$azimuth, name = 'azimuth', type = 'scatter', mode = 'markers') %>%
  add_trace(y = ~elektrownie_wykr$kwh, name = 'energia', mode = 'markers') %>%
  layout(title = 'Azymut - energia ',
         xaxis = list(title = 'Energia',
                      zeroline = TRUE),
         yaxis = list(title = 'Azymut'));
kor1;

kor2 <- plot_ly(elektrownie_wykr, x = ~data, y= elektrownie_wykr$tempi, name = 'temp', type = 'scatter', mode = 'markers') %>%
  add_trace(y = ~elektrownie_wykr$kwh, name = 'energia', mode = 'markers')%>%
  layout(title = 'Temperatura - energia ',
         xaxis = list(title = 'Energia',
                      zeroline = TRUE),
         yaxis = list(title = 'Temperatura'));
kor2;

kor3 <- plot_ly(elektrownie_wykr, x = ~data, y= elektrownie_wykr$pressure, name = 'pressure', type = 'scatter', mode = 'markers') %>%
  add_trace(y = ~elektrownie_wykr$kwh, name = 'energia', mode = 'markers')%>%
  layout(title = 'Cisnienie - energia',
         xaxis = list(title = 'Energia',
                      zeroline = TRUE),
         yaxis = list(title = 'Ciesnienie'));
kor3;

```


## Wykres zmiany wytwarzanej energii w czasie i przestrzeni {#section7}

```{r wykres_glowny, echo=TRUE, message=FALSE}
p_glowny <- plot_ly(elektrownie_wykr, x = ~kwh, y = ~ora, z = ~dist,
         marker = list(color = ~elektrownie_wykr$azimuth, colorscale = c('#FFE1A1', '#683531'), showscale = TRUE)) %>%
   add_markers() %>%
   layout(scene = list(xaxis = list(title = 'Energia'),
                      yaxis = list(title = 'Godzina'),
                      zaxis = list(title = 'Odleglosc')),
          annotations = list(
            x = 1.13,
            y = 1.05,
            text = 'Energia',
            xref = 'paper',
            yref = 'paper',
            showarrow = FALSE
          ))
p_glowny;

```

## Regresor przewiduj¹cy wytwarzan¹ energiê przez ka¿dy panel w ujêciu godzinowym {#section8}

```{r regresor, echo=TRUE, message=FALSE}
trainPart <- createDataPartition(
  y = elektrownie_wykr$idsito,
  p = .75,
  list = FALSE
)

training <- elektrownie_wykr[trainPart,];
testing <- elektrownie_wykr[-trainPart,];

ctrl <- trainControl(
    # powtórzona ocena krzy¿owa
    method = "repeatedcv",
    # liczba podzia³ów
    number = 2,
    # liczba powtórzeñ
    repeats = 5);

set.seed(23)
fit <- train(kwh ~ idsito,
              data = training,
              method = "gaussprLinear",
              trControl = ctrl);

fit;

set.seed(23)
fitnn <- train(kwh ~ idsito,
              data = training,
              method = "neuralnet",
              trControl = ctrl);

fitnn;

plotnn <- ggplot(fitnn) + theme_bw() ;
renderPlot(plotnn);

renderText("Trenowanie z parametrami - idsito i temperatura")
set.seed(23)
fitTemp <- train(kwh ~ idsito + tempi,
              data = training,
              method = "gaussprLinear",
              trControl = ctrl)

renderText("Trenowanie z parametrami - idsito, temperatura i wilgotnoœæ")
set.seed(23)
fitTempHum <- train(kwh ~ idsito + azimuth + cloudcover,
              data = training,
              method = "gaussprLinear",
              trControl = ctrl);
fitTempHum;

gClasses <- predict(fitTempHum, newdata = training);
postResample(gClasses, testing$kwh);

gClassesTest <- predict(fitTempHum, newdata = testing);
postResample(gClassesTest, testing$kwh)

```


## Analiza wa¿noœci atrybutów najlepszego znalezionego modelu regresji: {#section9}


```{r analyze, message=FALSE, echo=FALSE}
attributes_model <- plot_ly(elektrownie_wykr, x = ~data, y= elektrownie_wykr$kwh, name = 'energia', type = 'scatter', mode = 'markers') %>%
  add_trace(y = ~elektrownie_wykr$azimuth, name = 'Azymut', mode = 'markers') %>%
  add_trace(y = ~elektrownie_wykr$cloudcover, name = 'Zachmurzenie', mode = 'markers') %>%
  layout(title = 'Analiza atrybutów wybranego modelu',
         xaxis = list(title = 'Data',
                      zeroline = TRUE),
         yaxis = list(title = 'Energia'));

attributes_model
```


